"use strict";function FormatReader(){this.mimetype=["image/png","image/jpeg"],"undefined"!=typeof PDFJS&&(this.mimetype.push("application/pdf"),PDFJS.disableWorker=!1),"undefined"!=typeof Tiff&&(this.mimetype.push("image/tif"),this.mimetype.push("image/tiff"));try{var e=$window.AudioContext||$window.webkitAudioContext||$window.mozAudioContext||$window.msAudioContext;"undefined"!=typeof e&&(this.mimetype.push("audio/x-wav"),this.mimetype.push("audio/wav"),this.mimetype.push("audio/x-ogg"),this.mimetype.push("audio/ogg"),this.mimetype.push("audio/x-mpeg"),this.mimetype.push("audio/mpeg"))}catch(e){}}var nyplViewer=angular.module("nyplViewer",["ngMaterial","base64","ui.router","ui.layout","infinite-scroll","wu.masonry","ngLodash","firebase","ngStorage","ngMessages"]);angular.module("infinite-scroll").value("THROTTLE_MILLISECONDS",5e3).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,o){e.state("main",{url:"/",templateUrl:"src/grid-list/main.html",controller:"GridListCtrl",controllerAs:"gridList",params:{themeName:{value:null,dynamic:!0},searchTerms:{value:null,dynamic:!0}},resolve:{}}).state("admin",{url:"/admin",templateUrl:"src/admin/admin.html",controller:"AdminCtrl",controllerAs:"admin",resolve:{currentAuth:["Auth",function(e){return e.authObj.$waitForSignIn()}]}}),t.otherwise("/"),o.html5Mode({enabled:!0,requireBase:!1})}]).directive("stickyLoadingbar",["$mdSticky","$compile",function(e,t){var o='<div id="loadingbar" ng-hide="isloading" sticky><md-progress-linear md-mode="indeterminate" md-theme="dark-yellow"></md-progress-linear></div>';return{restrict:"E",scope:{isloading:"="},replace:!0,template:o,link:function(n,a){e(n,a,t(o)(n))}}}]).config(["$mdIconProvider","$mdThemingProvider",function(e,t){e.defaultIconSet("./assets/svg/avatars.svg",128).icon("search","./assets/svg/search.svg",24).icon("settings","./assets/svg/settings.svg",24).icon("binoculars","./assets/svg/binoculars.svg",48).icon("telescope","./assets/svg/telescope.svg",48).icon("spyglass","./assets/svg/spyglass.svg",48).icon("menu","./assets/svg/menu.svg",24).icon("share","./assets/svg/share.svg",24).icon("google_plus","./assets/svg/google_plus.svg",24).icon("hangouts","./assets/svg/hangouts.svg",24).icon("twitter","./assets/svg/twitter.svg",24).icon("pen","./assets/svg/fountain-pen.svg",24).icon("open-book","./assets/svg/open-book.svg",24).icon("google","./assets/svg/google.svg",24).icon("account","./assets/svg/account.svg",24).icon("sign-out","./assets/svg/sign-out.svg",24).icon("add-new","./assets/svg/add-new.svg",24).icon("add","./assets/svg/add.svg",24).icon("edit","./assets/svg/edit.svg",24).icon("delete","./assets/svg/garbage.svg",24).icon("bookmark","./assets/svg/bookmark.svg",24).icon("cancel","./assets/svg/cancel.svg",36).icon("about","./assets/svg/about.svg",24).icon("phone","./assets/svg/phone.svg",24),t.theme("default").primaryPalette("grey",{default:"400","hue-1":"200","hue-2":"600","hue-3":"50"}).accentPalette("amber"),t.theme("dark-yellow").primaryPalette("yellow",{default:"700"}),t.theme("light-grey").primaryPalette("grey",{default:"A100"}),t.theme("input","default").primaryPalette("grey")}]),nyplViewer.controller("AboutDialogCtrl",["$mdDialog",function(e){var t=this;t.hide=function(){e.hide()},t.cancel=function(){e.hide()},t.save=function(){}}]),nyplViewer.controller("AdminCtrl",["$mdDialog","lodash","DatabaseConnection","$mdToast","FirebaseStorageModel","$q","$scope",function(e,t,o,n,a,i,s){var r=this;r.submittedThemes=[],r.getSubmittedThemes=function(){a.getSubmittedThemes().then(function(e){t.forEach(e,function(e,t){e.id=t,e.selected=!1,r.submittedThemes.push(e)}),s.$apply()})},r.addToDefaults=function(){angular.forEach(r.submittedThemes,function(e){if(1==e.selected){var t=angular.toJson(e),o=JSON.parse(t);a.deleteSubmittedTheme(o),delete o.id,delete o.selected,a.createDefaultTheme(o)}}),r.showToast(r.submittedThemes.length+" themes added to defaults."),r.getSubmittedThemes()},r.showToast=function(e){n.show(n.simple().textContent(e).position("top right").hideDelay(1500))},r.deleteTheme=function(e){a.deleteSubmittedTheme(e),r.showToast("Theme removed from submitted queue.")},r.editTheme=function(){},r.getSubmittedThemes()}]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};nyplViewer.directive("canvasViewer",["$window","$http","$timeout","$q","NyplApiCalls",function(e,t,o,n,a){var i=new FormatReader;return{scope:{imageSource:"=src",overlays:"=overlays",title:"@title",options:"=options",picData:"=picdata",closeModal:"&"},restrict:"E",template:'<div class="viewer-container"><md-card class="info-card" flex="25" ng-show="showInfoPanel" style="z-index: 15;position: absolute;top: 80px;left: 0;background-color:white;visibility:visible;"><div layout-padding="" ><div id="loadingcircle" ng-hide="isLoadingDone" layout-padding=""><md-progress-circular md-mode="indeterminate" md-theme="dark-yellow" md-diameter="20px"> </md-progress-circular></div><div ng-show="isLoadingDone"><h4><b>Title: </b>{{title}}</h4><h6><b>Subject: </b>{{subjectsStr}}</h6><h6><b>Collection: </b>{{collection}}</h6><h6><b>Genres: </b>{{genreStr}}</h6><h6><b>Origin info: </b>{{originInfoStr}}</h6><h6><b>Physical description: </b>{{physicalDescription}}</h6><h6><b>Notes: </b>{{noteStr}}</h6></div></div></md-card><div style="z-index : 15;position:absolute;top:0px;right:0px;visibility:visible;"><md-button  class="md-icon-button" ng-click="logThis()"><md-icon style="color:height:36px;width:36px;" md-svg-icon="cancel" md-menu-align-target=""></md-icon></md-button></div><canvas class="viewer" ng-mouseleave="canMove=false"ng-mousedown="mousedown($event)"ng-mouseup="mouseup($event)"ng-init="canMove=false"ng-mousemove="mousedrag($event,canMove)"></canvas><div class="title" ng-if="title!=null">{{title}}</div><div class="statictitle"><h6 style="color:white;">{{picData.title}}</h6></div><div class="command" style="visibility:visible;" ng-if="options.controls.image"><div class="btn btn-warning" ng-click="showInfo()" ><i class="fa fa-info-circle" aria-hidden="true"></i></div><div class="btn btn-warning" ng-click="options.controls.numPage=options.controls.numPage-1" ng-hide="options.controls.totalPage==1"><i class="fa fa-minus"></i></div><div class="btn btn-warning" ng-hide="options.controls.totalPage==1">{{options.controls.numPage}}/{{options.controls.totalPage}}</div><div class="btn btn-warning" ng-click="options.controls.numPage=options.controls.numPage+1" ng-hide="options.controls.totalPage==1"><i class="fa fa-plus"></i></div><div class="btn btn-warning" ng-click="resizeTo(\'page\')"><i class="fa fa-file-o"></i></div><div class="btn btn-warning" ng-click="rotate(-1)" ng-hide="options.controls.disableRotate"><i class="fa fa-rotate-left"></i></div><div class="btn btn-warning" ng-click="rotate(1)" ng-hide="options.controls.disableRotate"><i class="fa fa-rotate-right"></i></div><div class="btn btn-warning" ng-click="zoom(-1)" ng-hide="options.controls.disableZoom"><i class="fa fa-search-minus"></i></div><div class="btn btn-warning" ng-click="zoom(1)" ng-hide="options.controls.disableZoom"><i class="fa fa-search-plus"></i></div></div><div class="command" ng-if="options.controls.sound"><div class="btn btn-warning" ng-click="stop()"><i class="fa fa-stop"></i></div><div class="btn btn-warning" ng-click="play()"><i class="fa fa-play"></i></div></div></div>',link:function(t,s,r,l){function c(){null!=T&&(T.rendered?u():t.resizeTo(t.options.controls.fit))}function u(){if(null!=T&&T.rendered){var e=t.options,o=m.canvas,n=T.width*e.zoom.value/2,a=T.height*e.zoom.value/2;if(m.clearRect(0,0,o.width,o.height),m.save(),m.translate(y.x+n,y.y+a),m.rotate(e.rotate.value*Math.PI/180),m.translate(-n,-a),T.isZoom&&m.scale(e.zoom.value,e.zoom.value),e.controls.filmStrip&&1!=e.controls.totalPage){if(null!=T.images&&angular.forEach(T.images,function(e){m.drawImage(e,0,0,e.width,e.height),m.beginPath(),m.rect(0,0,e.width,e.height),m.lineWidth=.2,m.strokeStyle="#000000",m.stroke(),m.translate(0,e.height+15)}),null!=T.data){var i=0;angular.forEach(T.data,function(e){m.putImageData(e,y.x,y.y+i),m.beginPath(),m.rect(0,0,T.width,T.height),m.lineWidth=.2,m.strokeStyle="#000000",m.stroke(),i+=T.height+15,m.translate(0,i)})}}else null!=T.img&&(m.drawImage(T.img,0,0,T.width,T.height),m.beginPath(),m.rect(0,0,T.width,T.height),m.lineWidth=.2,m.strokeStyle="#000000",m.stroke()),null!=T.data&&(m.putImageData(T.data,y.x,y.y),m.beginPath(),m.rect(0,0,T.width,T.height),m.lineWidth=.2,m.strokeStyle="#000000",m.stroke());m.restore(),I.length>0&&angular.forEach(I,function(t){m.save(),m.translate(y.x+n,y.y+a),m.rotate(e.rotate.value*Math.PI/180),m.translate(-n,-a),m.scale(e.zoom.value,e.zoom.value),m.beginPath(),m.rect(t.x,t.y,t.w,t.h),m.fillStyle=t.color,m.globalAlpha=.4,m.fill(),m.lineWidth=1,m.strokeStyle=t.color,m.stroke(),m.restore()})}}function h(){t.$applyAsync(function(){var e=g.parentNode;m.canvas.width=e.clientWidth,m.canvas.height=e.clientHeight,u()})}function d(){return v.width!=g.parentNode.clientWidth&&(v.width=g.parentNode.clientWidth),v.height!=g.parentNode.clientHeight&&(v.height=g.parentNode.clientHeight),v}t.showInfoPanel=!1,t.isLoadingDone=!1,t.showInfo=function(){t.showInfoPanel=!t.showInfoPanel,t.showInfoPanel&&(t.isLoadingDone=!1,a.getDetail(t.picData.apiItemDetailURL).then(function(e){t.metadata=e.nyplAPI.response.mods;try{t.title=t.metadata.titleInfo.title.$}catch(e){t.title=""}try{t.values="",t.subjectsStr="",t.metadata.hasOwnProperty("subject")&&angular.forEach(t.metadata.subject,function(e){e.hasOwnProperty("name")&&(t.subjectsStr=t.subjectsStr+"Name: "+e.name.namePart.$+" "),e.hasOwnProperty("topic")&&(t.subjectsStr=t.subjectsStr+"Topic: "+e.topic.$+" "),e.hasOwnProperty("geographic")&&(t.subjectsStr=t.subjectsStr+"Geographic: "+e.geographic.$+" ")})}catch(e){t.subjectsStr=""}try{t.collection=t.metadata.nyplAPI.response.mods.location[0].physicalLocation[2].$}catch(e){t.collection=""}try{t.values="",t.metadata.hasOwnProperty("originInfo")&&(Array.isArray(t.metadata.originInfo)?angular.forEach(t.metadata.originInfo,function(e){e.hasOwnProperty("place")&&(t.originInfoStr="Place: "+e.place.placeTerm.$+" "),e.hasOwnProperty("dateIssued")&&(t.originInfoStr="Date issued: "+e.dateIssued.$),e.hasOwnProperty("dateCreated")&&(Array.isArray(e.dateCreated)?(t.originInfoStr="Created date: ",angular.forEach(e,function(e){e.hasOwnProperty("qualifier")&&(t.originInfoStr=t.originInfoStr+e.qualifier+" "),e.hasOwnProperty("point")&&(t.originInfoStr=t.originInfoStr+e.point+" "),e.hasOwnProperty("$")&&(t.originInfoStr=t.originInfoStr+e.$+" ")})):t.originInfoStr="Created date: "+e.dateCreated.$+" ")}):(t.metadata.originInfo.hasOwnProperty("place")&&(t.originInfoStr="Place: "+t.metadata.originInfo.place.placeTerm.$+" "),t.metadata.originInfo.hasOwnProperty("dateIssued")&&(t.originInfoStr="Date issued: "+t.metadata.originInfo.dateIssued.$),t.metadata.originInfo.hasOwnProperty("dateCreated")&&(Array.isArray(t.metadata.originInfo.dateCreated)?(t.originInfoStr="Created date: ",angular.forEach(t.metadata.originInfo.dateCreated,function(e){e.hasOwnProperty("qualifier")&&(t.originInfoStr=t.originInfoStr+e.qualifier+" "),e.hasOwnProperty("point")&&(t.originInfoStr=t.originInfoStr+e.point+" "),e.hasOwnProperty("$")&&(t.originInfoStr=t.originInfoStr+e.$+" ")})):t.originInfoStr="Created date: "+t.metadata.originInfo.dateCreated.$+" ")))}catch(e){console.log(e),t.originInfoStr=""}try{t.values="",t.metadata.hasOwnProperty("note")&&(t.noteStr="",Array.isArray(t.metadata.note)?(t.noteStr="",angular.forEach(t.metadata.note,function(e){e.hasOwnProperty("$")&&(t.noteStr=t.noteStr+e.$+", ")})):t.noteStr=t.metadata.note.$)}catch(e){t.noteStr=""}try{t.metadata.hasOwnProperty("genre")&&(t.genreStr="",Array.isArray(t.metadata.genre)?(t.genreStr="",angular.forEach(t.metadata.genre,function(e){e.hasOwnProperty("$")&&(t.genreStr=t.genreStr+e.$+", ")})):t.genreStr=t.metadata.genre.$)}catch(e){t.genreStr=""}t.physicalDescription="",t.isLoadingDone=!0}))},t.logThis=function(){t.closeModal()};var g=s.find("canvas")[0],m=g.getContext("2d"),f=angular.element(s.find("div")[0])[0],p=(f.parentNode.parentNode,g.parentNode);m.canvas.width=p.clientWidth,m.canvas.height=p.clientHeight;var v={height:p.clientHeight,width:p.clientWidth},w={x:0,y:0},y={x:0,y:0},b={x:0,y:0},I=[],T=null;t.options=angular.merge({},{ctx:null,adsrc:null,zoom:{value:1,step:.1,min:.05,max:6},rotate:{value:0,step:90},controls:{toolbar:!0,image:!0,sound:!1,fit:"page",disableZoom:!1,disableMove:!1,disableRotate:!1,numPage:1,totalPage:1,filmStrip:!1},info:{}},t.options),t.options.ctx=m,t.$watch("imageSource",function(e){if(void 0!==e&&null!==e)if(t.options.zoom.value=1,t.options.rotate.value=0,w={x:0,y:0},y={x:0,y:0},"object"===("undefined"==typeof e?"undefined":_typeof(e)))if(i.IsSupported(e.type)){var a=i.CreateReader(e.type,e);T=a.create(e,t.options,c,n,o,m)}else console.log(e.type," not supported !");else"string"==typeof e&&(T=i.CreateReader("image/jpeg").create(e,t.options,c,n,o))}),t.$watch("overlays",function(e,t){null!==e&&null!==t&&(I=[],angular.forEach(e,function(e){I.push(e)}),u())},!0),t.$watch("options.zoom.value",function(){t.options.controls.disableZoom||u()}),t.$watch("options.rotate.value",function(){t.options.controls.disableRotate||u()}),t.$watch("options.controls.fit",function(e){t.resizeTo(e)}),t.$watch("options.controls.filmStrip",function(e){e?(t.options.controls.disableMove=!0,t.options.controls.disableRotate=!0):(t.options.controls.disableMove=!1,t.options.controls.disableRotate=!1),null!=T.refresh&&T.refresh()}),t.$watch("options.controls.numPage",function(e){t.options.controls.numPage<1&&(t.options.controls.numPage=1),t.options.controls.numPage>t.options.controls.totalPage&&(t.options.controls.numPage=t.options.controls.totalPage),null!=T&&(t.options.controls.filmStrip?(y.y=(t.options.controls.numPage-1)*-(T.height+15),u()):null!=T.refresh&&T.refresh())}),angular.element(g).bind("DOMMouseScroll mousewheel onmousewheel",function(o){var n=e.event||o,a=Math.max(-1,Math.min(1,n.wheelDelta||-n.detail));t.options.controls.filmStrip?(y.y+=50*a,y.y>15&&(y.y=15),T.images?y.y-T.height*t.options.zoom.value<-(T.height+15)*T.images.length*t.options.zoom.value&&(y.y=-(T.height+15)*T.images.length+T.height):y.y-T.height*t.options.zoom.value<-T.height*t.options.zoom.value&&(y.y=-T.height*t.options.zoom.value),t.$applyAsync(function(){u()})):a>0?t.zoom(1):t.zoom(-1),n.returnValue=!1,n.preventDefault&&n.preventDefault()}),angular.element(g).bind("mousedown",function(e){t.options.controls.disableMove||(t.canMove=!0,w.x=e.offsetX,w.y=e.offsetY)}),angular.element(g).bind("mouseup",function(e){t.options.controls.disableMove||(t.canMove=!1)}),angular.element(g).bind("mousemove",function(e){if(b.x=e.offsetX,b.y=e.offsetY,!t.options.controls.disableMove&&null!==T&&t.canMove){var o=e.offsetX,n=e.offsetY,a=o-w.x,i=n-w.y;y.x+=a,y.y+=i,u(),w.x=o,w.y=n}}),t.zoom=function(e){t.$applyAsync(function(){var o,n,a=0,i=0;T.isZoom?(o=T.width*t.options.zoom.value,n=T.height*t.options.zoom.value):(o=T.oldwidth,n=T.height),t.options.zoom.value+=t.options.zoom.step*e,t.options.zoom.value=Math.round(100*t.options.zoom.value)/100,t.options.zoom.value>=t.options.zoom.max&&(t.options.zoom.value=t.options.zoom.max),t.options.zoom.value<=t.options.zoom.min&&(t.options.zoom.value=t.options.zoom.min),null!=T.refresh&&T.refresh(),T.isZoom?(a=T.width*t.options.zoom.value,i=T.height*t.options.zoom.value):(a=T.width,i=T.height),y.x=y.x-(a-o)/2,y.y=y.y-(i-n)/2})},t.rotate=function(e){t.$applyAsync(function(){t.options.rotate.value+=t.options.rotate.step*e,(t.options.rotate.value<=-360||t.options.rotate.value>=360)&&(t.options.rotate.value=0),u()})};var S=function(){var e=m.canvas.width/2,o=m.canvas.height/2,n=0,a=o-T.height*t.options.zoom.value/2;n=e-T.width*t.options.zoom.value/2,w={x:n,y:0},y={x:n,y:a}};t.resizeTo=function(e){if(null!=m.canvas&&null!=T){var o=(t.options,m.canvas.height/T.height),n=m.canvas.width/T.width;switch(T.isZoom||(o*=t.options.zoom.value,n*=t.options.zoom.value),e){case"width":t.options.zoom.value=n;break;case"height":t.options.zoom.value=o;break;case"page":default:t.options.zoom.value=Math.min(o,n)/2}t.$applyAsync(function(){t.options.zoom.value=Math.round(100*t.options.zoom.value)/100,t.options.controls.fit=e,T.isZoom?(S(),u()):(null!=T.refresh&&T.refresh(),S())})}},t.play=function(){null!=t.options.adsrc&&t.options.adsrc.start(0)},t.stop=function(){null!=t.options.adsrc&&t.options.adsrc.stop(0)},t.$watch(d,function(){h()},!0)}}}]),FormatReader.prototype={pdfReader:function(e,t,o,n,a,i){function s(e,n,a){void 0==n&&(n=r.currentPage),void 0==a&&(a=e.page);var i=document.createElement("canvas"),s=i.getContext("2d");if(null!=a){e.rendering=!0,e.oldwidth=e.width,e.oldheight=e.height,0==Math.abs(e.options.zoom.value)&&(e.options.zoom.value=1);var l=a.getViewport(e.options.zoom.value,0);return s.canvas.width=l.width,s.canvas.height=l.height,a.render({canvasContext:s,viewport:l,intent:"display"}).then(function(){if(e.width=l.width,e.height=l.height,t.controls.filmStrip){var a=s.getImageData(0,0,l.width,l.height);a.pageNum=n,e.data.push(a),e.data.length==t.controls.totalPage&&(e.data.sort(function(e,t){return e.pageNum-t.pageNum}),e.rendered=!0,o(),e.rendering=!1)}else r.data=s.getImageData(0,0,l.width,l.height),r.rendered=!0,o(),e.rendering=!1})}}t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var r=this;return r.context=i,r.$q=n,r._pdfDoc=null,r.viewport=null,r.img=new Image,r.rendered=!1,r.width=-1,r.height=-1,r.oldwidth=-1,r.oldheight=-1,r.data=null,r.page=null,r.options=t,r.currentPage=-1,r.rendering=!1,r.isZoom=!1,r.data=[],r.triggerRefresh=!1,this.refresh=function(){if(null!=r._pdfDoc&&!parent.rendering)if(r.rendered=!1,t.controls.filmStrip){var e=1,o=[];r.data=[];for(var e=1;e<=t.controls.totalPage;e++)o.push(r._pdfDoc.getPage(e));r.$q.all(o).then(function(e){for(var t=0;t<e.length;t++)s(r,e[t].pageIndex,e[t])})}else r.currentPage!=r.options.controls.numPage?r._pdfDoc.getPage(r.options.controls.numPage).then(function(e){s(r,r.options.controls.numPage,e)}):s(r,r.options.controls.numPage,page)},this.reader.onload=function(){var e=new Uint8Array(r.reader.result);PDFJS.getDocument({data:e}).then(function(e){r._pdfDoc=e,t.controls.totalPage=e.numPages,t.controls.numPage=1,r._pdfDoc.getMetadata().then(function(e){t.info=e.info,t.info.metadata=e.metadata}),r.refresh()})},this.reader.readAsArrayBuffer(e),this},tiffReader:function(e,t,o){t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var n=this;return n.rendered=!1,n.tiff=null,n.img=null,n.data=null,n.width=-1,n.height=-1,n.options=t,n.images=[],n.currentPage=-1,n.isZoom=!0,this.refresh=function(){if(void 0!=n.reader.result)if(null==n.tiff&&(n.tiff=new Tiff({buffer:n.reader.result}),n.options.controls.totalPage=n.tiff.countDirectory(),n.options.controls.numPage=1,n.options.info={width:n.tiff.width(),height:n.tiff.height(),compression:n.tiff.getField(Tiff.Tag.COMPRESSION),document:n.tiff.getField(Tiff.Tag.DOCUMENTNAME),description:n.tiff.getField(Tiff.Tag.IMAGEDESCRIPTION),orientation:n.tiff.getField(Tiff.Tag.ORIENTATION),xresolution:n.tiff.getField(Tiff.Tag.XRESOLUTION),yresolution:n.tiff.getField(Tiff.Tag.YRESOLUTION)}),n.options.controls.numPage>n.options.controls.totalPage&&(n.options.controls.numPage=n.options.controls.totalPage),n.options.controls.filmStrip){n.images=[];for(var e=0;e<n.tiff.countDirectory();e++)n.tiff.setDirectory(e),0==e&&(n.width=n.tiff.width(),n.height=n.tiff.height()),n.images[e]=new Image,n.images[e].onload=function(){1==n.images.length&&(n.img=n.images[0]),o(),n.rendered=!0},n.images[e].src=n.tiff.toDataURL(),n.images[e].pageNum=e}else n.currentPage!=n.options.controls.numPage&&(n.tiff.setDirectory(n.options.controls.numPage-1),n.width=n.tiff.width(),n.height=n.tiff.height(),n.img=new Image,n.img.onload=function(){o(),n.rendered=!0},n.img.src=n.tiff.toDataURL(),n.currentPage=n.options.controls.numPage)},this.reader.onload=function(){null!=n.tiff&&(n.tiff.close(),n.tiff=null),Tiff.initialize({TOTAL_MEMORY:83886080}),n.refresh()},this.reader.readAsArrayBuffer(e),this},imageReader:function(e,t,o){t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var n=this;return n.img=new Image,n.img.onload=function(){n.width=n.img.width,n.height=n.img.height,o(),n.rendered=!0},n.data=null,n.width=-1,n.height=-1,t.info={},n.isZoom=!0,n.rendered=!1,this.reader.onload=function(){n.img.src=n.reader.result},"string"==typeof e?n.img.src=e:this.reader.readAsDataURL(e),t.controls.totalPage=1,t.controls.numPage=1,this.refresh=function(){},this},mpegReader:function(e,t,o){},wavReader:function(e,t,o){t.controls.toolbar&&(t.controls.image=!1,t.controls.sound=!0),this.reader=new FileReader;var n=this,a=t.ctx;this.width=a.canvas.width,this.height=a.canvas.height;try{$window.AudioContext=$window.AudioContext||$window.webkitAudioContext||$window.mozAudioContext||$window.msAudioContext,$window.requestAnimationFrame=$window.requestAnimationFrame||$window.webkitRequestAnimationFrame||$window.mozRequestAnimationFrame||$window.msRequestAnimationFrame,$window.cancelAnimationFrame=$window.cancelAnimationFrame||$window.webkitCancelAnimationFrame||$window.mozCancelAnimationFrame||$window.msCancelAnimationFrame;var i=new AudioContext;this.reader.onload=function(){i.decodeAudioData(n.reader.result,function(e){var o=a.createLinearGradient(0,0,0,n.height);o.addColorStop(1,"#000000"),o.addColorStop(.75,"#ff0000"),o.addColorStop(.25,"#ffff00"),o.addColorStop(0,"#ffffff");var s=i.createScriptProcessor(2048,1,1),r=i.createBufferSource();t.adsrc=r,r.buffer=e;var l=i.createAnalyser();l.smoothingTimeConstant=.3,l.fftSize=512,r.connect(l),l.connect(s),s.onaudioprocess=function(){var e=new Uint8Array(l.frequencyBinCount);l.getByteFrequencyData(e),a.clearRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle=o;for(var t=0;t<e.length;t++){var i=e[t];a.fillRect(5*t,n.height-i,3,n.height)}},s.connect(i.destination),r.connect(i.destination)})},this.reader.readAsArrayBuffer(e)}catch(e){}},CreateReader:function(e,t){var o=null;switch(""==e&&(e=this.GuessMimeType(t)),e.toLowerCase()){case"image/tif":case"image/tiff":o={create:this.tiffReader};break;case"application/pdf":o={create:this.pdfReader};break;case"image/png":case"image/jpeg":o={create:this.imageReader};break;case"audio/x-wav":case"audio/wav":case"audio/x-ogg":case"audio/ogg":o={create:this.wavReader};break;case"audio/x-mpeg":case"audio/mpeg":o={create:this.mpegReader}}return o},IsSupported:function(e){return this.mimetype.indexOf(e)!=-1},GuessMimeType:function(e){var t="";if(""==e.type){var o=e.name;t="image/"+o.substring(o.indexOf(".")+1)}return t.toLowerCase()}},nyplViewer.controller("GridListCtrl",["$q","$http","NyplApiCalls","$location","$state","$scope","$mdMedia","$mdDialog","lodash","$mdToast","Auth","$stateParams","FirebaseStorageModel",function(e,t,o,n,a,i,s,r,l,c,u,h,d){var g=this;g.pics=[],g.masonryImages=[],g.searchPage=0,g.isLoadingDone=!0,g.isSearchByThemeModeOn=!1,g.modeDescription="Search",g.isPageInfoRetrieved=!1,g.isMoreSearchItems=!0,g.interestSearches=[],g.isInitialLoad=!0,g.searchRanCount=0,g.metadataFilter="All",this.uiOnParamsChanged=function(e){},g.defaultSearches=["steamboats","American civil war","Samuel colt","Brooklyn bridge","firearms","rough riders","plains indians"],g.searchText=l.sample(g.defaultSearches),g.searchItems=[],g.searchResults=[];var m;g.isOpen=!1,g.connected=!1,g.initInterestSearches=function(){return deferred=e.defer(),0!=g.interestSearches.length?deferred.resolve():d.getSettings().then(function(e){g.settings=e,null==g.settings?g.selectedInterests=[]:(console.log(g.settings.interests),g.selectedInterests=g.settings.interests,angular.forEach(g.selectedInterests,function(e){g.interestSearches.push({searchTerm:e,startPage:1,page:1,totalPages:0,isMorePages:!0})})),deferred.resolve()}),deferred.promise},g.authItems={default:{name:"Default user",icon:"account",direction:"bottom",show:"true",username:"",tooltip:"Signed in as the Default user."},anonymous:{name:"Anonymous",icon:"account",direction:"bottom",show:"true",username:"",tooltip:"Signed in Anonymously."},google:{name:"Google",icon:"google",direction:"top",show:"true",username:"",tooltip:""},signout:{name:"Sign out",icon:"sign-out",direction:"bottom",show:"false"}},g.account=g.authItems.default,g.authEvent=function(e){console.log(e),"Sign out"==e.name?(u.authObj.$signOut(),g.authItems.default.show=!0,g.authItems.google.show=!0,g.authItems.signout.show=!1,g.account=g.authItems.default):u.authenticate(e.name).then(function(e){if(void 0!=e.user)if(console.log("Signed in as:",e.user),e.user.isAnonymous)g.authItems.default.show=!1,g.authItems.google.show=!0,g.authItems.anonymous.show=!1,g.authItems.signout.show=!0,g.authItems.google.username=t,g.account=g.authItems.anonymous;else{g.authItems.default.show=!1,g.authItems.google.show=!1,g.authItems.signout.show=!0;var t=e.user.displayName.substring(0,1);g.authItems.google.tooltip="Signed in with Google: "+e.user.email,g.authItems.google.username=t,g.account=g.authItems.google}else console.log(e.errorCode+" "+e.errorMessage)}).catch(function(e){console.error("Authentication failed:",e)})},g.openMenu=function(e,t){m=t,e(t)},g.authenticate=function(){u.authenticate()},g.showSearchItems=function(){console.log(g.theme.items)},g.showPics=function(){console.log(g.pics)},g.modeChange=function(){g.isSearchByThemeModeOn?(n.url(n.path()),g.pics=[],g.masonryImages=[],g.isMoreSearchItems=!0,g.isPageInfoRetrieved=!1,g.modeDescription="Theme",g.loadMore()):(g.modeDescription="Search",g.searchTextChange())},g.searchTextChange=function(){g.isSearchByThemeModeOn=!1,g.pics=[],g.masonryImages=[],g.isMoreSearchItems=!0,g.modeDescription="Search",g.searchPage=0,g.loadMore()},g.search=function(e){return console.log("running straight search"),g.isLoadingDone=!1,g.searchPage++,o.nyplSearch(e,g.searchPage,g.metadataFilter).then(function(t){g.searchRanCount=g.searchRanCount+1;var o=g.extract(t);return void 0==t.data.nyplAPI.response.result?(g.isMoreSearchItems=!1,g.isLoadingDone=!0,void g.showNoMoreResultsToast()):(angular.forEach(o,function(e){g.pics.find(g.isDuplicate,e.title)||g.buildThumbnail(e)}),g.searchRanCount<3&&g.pics.length<20&&g.isMoreSearchItems?g.search(e,g.searchPage):void(g.isLoadingDone=!0))})},g.getTheme=function(){deferred=e.defer();var t=u.authObj.$getAuth();return null==g.theme&&t?d.getUserInfo().then(function(e){null==e.selectedTheme?console.log("No settings available  for this user!"):(g.theme=e.selectedTheme,g.searchText=g.theme.name),deferred.resolve()}):deferred.resolve(),deferred.promise},g.setQueryParams=function(){var e="",t="";t=g.theme.name,angular.forEach(g.theme.items,function(t){e=""==e?t.search:e+","+t.search}),a.go(".",{themeName:t,searchTerms:e},{notify:!1})},g.loadMore=function(){if(g.searchRanCount=0,g.apiLoadCount=0,null!=h.searchTerms&&1==g.isInitialLoad){null==h.themeName?(g.searchText=h.searchTerms,g.isSearchByThemeModeOn=!1):g.searchText=h.themeName,g.theme={name:h.themeName,items:[]};var e=h.searchTerms.split(",");angular.forEach(e,function(e){var t={search:e,page:1,totalPages:null,isPageInfoRetrieved:!1};g.theme.items.push(t)}),g.isInitialLoad=!1}g.isSearchByThemeModeOn?(g.searchResults=[],g.getTheme().then(function(){g.setQueryParams(),g.themeSearch()})):(g.search(g.searchText),a.go(".",{themeName:null,searchTerms:g.searchText},{notify:!1}))},g.incrementInterestSearchPage=function(e){var t=e.page+1;t>e.totalPages&&e.startPage>=1&&(t=1),t==e.startPage||t>e.totalPages?e.isMorePages=!1:e.page=t},g.isSearchesExhausted=function(e){var t=!0;return angular.forEach(e,function(e){1==e.isMorePages&&(t=!1)}),t},g.themeSearch=function(){return console.log("running theme search"),searches=[],angular.forEach(g.theme.items,function(e){if(0==e.isPageInfoRetrieved||e.page<=e.totalPages){var t=o.nyplSearch(e.search,e.page);e.page=e.page+1,searches.push(t)}}),0==searches.length?(g.isMoreSearchItems=!1,g.showNoMoreResultsToast(),void(g.isLoadingDone=!0)):g.runApiSearches(searches).then(function(e){return g.searchRanCount=g.searchRanCount+1,angular.forEach(e,function(e,t){g.theme.items[t].totalPages=e.data.nyplAPI.request.totalPages,g.theme.items[t].isPageInfoRetrieved=!0;var o=g.extract(e);angular.forEach(o,function(e){g.searchResults.push(e)})}),g.searchRanCount<3&&g.searchResults.length<20&&g.isMoreSearchItems?g.themeSearch(g.theme.items):(g.searchResults=l.shuffle(g.searchResults),void angular.forEach(g.searchResults,function(e){g.pics.find(g.isDuplicate,e.title)||g.buildThumbnail(e)}))})},g.searchByInterests=function(e){g.isLoadingDone=!1,searches=[],g.initInterestSearches().then(function(){console.log(g.interestSearches),g.getPageInfoForInterestSearches(e).then(function(){return g.isSearchesExhausted(e)?(g.isMoreSearchItems=!1,g.showNoMoreResultsToast(),void(g.isLoadingDone=!0)):(angular.forEach(e,function(e){if(e.isMorePages){var t=o.nyplSearch(e.searchTerm,e.page);searches.push(t)}}),g.runApiSearches(searches).then(function(t){return angular.forEach(t,function(t,o){g.incrementInterestSearchPage(e[o]);var n=g.extract(t);angular.forEach(n,function(e){g.searchItems.push(e)})}),g.searchItems.length<20&&g.isMoreSearchItems?g.searchByInterests(e):(g.searchItems=l.shuffle(g.searchItems),angular.forEach(g.searchItems,function(e){g.pics.find(g.isDuplicate,e.title)||g.buildThumbnail(e)}),void(g.isLoadingDone=!0))}))})})},g.isDuplicate=function(e){return e.title===String(this)},g.extract=function(e){return void 0===e.data?[]:e.data.nyplAPI.response.result},g.initStartPageNum=function(e){return l.random(1,e)},g.getPageInfoForInterestSearches=function(t){var n=e.defer();if(g.isPageInfoRetrieved)n.resolve();else{var a=[];angular.forEach(t,function(e){var t=o.nyplSearch(e.searchTerm,e.page);a.push(t)}),g.runApiSearches(a).then(function(e){angular.forEach(e,function(e,o){var n=e.data.nyplAPI.request.totalPages,a=g.initStartPageNum(n);t[o].totalPages=n,t[o].startPage=a,t[o].page=a}),g.isPageInfoRetrieved=!0,n.resolve()})}return n.promise},g.showNoMoreResultsToast=function(){c.show(c.simple().textContent("No more results found!").position("top right").hideDelay(1500))},g.runApiSearches=function(t){g.isLoadingDone=!1;var o=e.defer();return e.all(t).then(function(e){g.isLoadingDone=!0,o.resolve(e)},function(e){}),o.promise},g.getPics=function(){console.log(g.pics)},g.buildThumbnail=function(e){if(void 0!=e.imageID){var t={};t.data=e,t.title=e.title,t.fullImageUrl="https://images.nypl.org/index.php?id="+e.imageID+"&t=w",s("sm")||s("xs")?(console.log("sm device..."),t.cropped=t.fullImageUrl):t.cropped="https://images.nypl.org/index.php?id="+e.imageID+"&t=r";var o=new Image;o.src=t.fullImageUrl,t.actualHeight=~~(500*Math.random())+100,t.actualWidth=o.width,t.showImageDetail=g.showImageDetail,t.imageID=e.imageID,g.pics.push(t)}},g.showSettings=function(e){var t=s("sm")||s("xs");r.show({controller:"SettingsDialogCtrl",controllerAs:"settingsCtrl",templateUrl:"src/grid-list/settings-dialog.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:t}).then(function(e){g.status='You said the information was "'+e+'".'},function(){g.status="You cancelled the dialog."})},g.showAbout=function(e){var t=s("sm")||s("xs");r.show({controller:"AboutDialogCtrl",controllerAs:"aboutCtrl",templateUrl:"src/about/about-dialog.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:t}).then(function(e){g.status='You said the information was "'+e+'".'},function(){g.status="You cancelled the dialog."})},g.getItemThumbnails=function(e){angular.forEach(e,function(e,t){g.pics.find(g.isDuplicate,e.title)||g.getThumbnail(e)})},g.isImageClicked=!1,g.showViewer=function(e,t){if(s("sm")||s("xs"))return void console.log("sm device exiting...");
var o=!0;r.show({locals:{picInfo:t.data,picUrl:t.fullImageUrl},controller:"ImageViewerCtrl",controllerAs:"viewer",templateUrl:"src/grid-list/image-viewer.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:o}).then(function(e){g.status='You said the information was "'+e+'".'},function(){g.status="You cancelled the dialog."})},g.showModal=function(e){var t={url:"data-original",inline:!1,build:function(e){g.isViewerBuilt=!1},built:function(e){g.isViewerBuilt=!0,i.$apply()}};$(".image").viewer(t)},g.showImageDetail=function(e){g.isImageClicked=!0,g.showModal(e)},g.initProfile=function(){var e=u.authObj.$getAuth();if(e)if(console.log("Signed in as:",e.uid),g.authItems.default.show=!1,g.authItems.google.show=!1,g.authItems.signout.show=!0,e.isAnonymous)g.authItems.google.show=!0,g.authItems.signout.show=!0,g.authItems.anonymous.show=!0,g.account=g.authItems.anonymous;else{var t=e.displayName.substring(0,1);g.authItems.google.tooltip="Signed in with Google: "+e.email,g.authItems.google.username=t,g.account=g.authItems.google}else u.authenticate("Anonymous").then(function(e){g.authItems.signout.show=!1,g.account=g.authItems.anonymous,console.log("Logged in as Anonymous")})}}]),nyplViewer.controller("ImageViewerCtrl",["$mdDialog","picInfo","picUrl","$http","lodash",function(e,t,o,n,a){var i=this;i.detailUrl=t.apiItemDetailURL,i.picData=t,i.title=t.title,console.log(i.picData),i.file=o,i.options={zoom:{value:1,step:.1},rotate:{value:90}},i.hide=function(){e.hide()},i.cancel=function(){e.hide()}}]),nyplViewer.controller("SettingsDialogCtrl",["$mdDialog","lodash","$q","NyplApiCalls","$mdToast","FirebaseStorageModel","$location",function(e,t,o,n,a,i,s){var r=this;r.readonly=!1,r.selectedItem=null,r.searchText="",r.autocompleteDemoRequireMatch=!0,r.themes=[],r.isResultsForNewThemeItem=!1,r.isSearchRun=!1,r.newThemeItemName="",r.newThemeItemResultCount=0,r.isLoadingDone=!0,r.isEditingTheme=!1,r.isNew=!1,r.theme=void 0,r.newTheme={isDefault:!1,name:"",items:[]},r.newThemeItem={search:"",page:1,totalPages:0,isPageInfoRetrieved:!1},r.addTheme=function(){r.isNew=!0},r.filter=function(e){var o=t.filter(r.themes,function(t){return t.name.indexOf(e)>-1});return o},r.querySearch=function(e){var t=e?r.filter(e):r.themes;return t},r.getThemes=function(){r.themes=[],i.getThemes().then(function(e){t.forEach(e,function(e,t){e.id=t,e.isDefault=!1,r.themes.push(e)})}),i.getDefaultThemes().then(function(e){t.forEach(e,function(e,t){e.id=t,e.isDefault=!0,r.themes.push(e)})})},r.showToast=function(e){a.show(a.simple().textContent(e).position("top right").hideDelay(1500))},r.isDuplicateObject=function(e,o,n){return t.find(e,function(e){return e[o]==n})},r.isDuplicateArrayElement=function(e,o){return void 0!=t.find(e,function(e){return e==o})},r.addThemeItem=function(){r.isDuplicateObject(r.newTheme.items,"search",r.newThemeItem.search)?r.showToast("Theme item already in your theme!"):(r.newTheme.items.push(r.newThemeItem),r.newThemeItem={search:"",page:1,totalPages:0,isPageInfoRetrieved:!1},r.isSearchRun=!1,r.isResultsForNewThemeItem=!1)},r.saveTheme=function(){if(""===r.newTheme.name)return void r.showToast("Theme name not entered. Save failed!");if(r.newTheme.items.length<1)return void r.showToast("No new theme items present. Save failed!");if(r.newTheme.items.length<2)return void r.showToast("A new theme must have at lease 2 theme items. Save failed!");if(!r.isDuplicateObject(r.themes,"name",r.newTheme.name)||r.isEditing){var e=angular.toJson(r.newTheme),t=JSON.parse(e);r.isEditing?(t.isDefault?i.editDefaultTheme(t):i.editTheme(t),r.isEditing=!1):(i.createTheme(t),r.isNew=!1),r.newTheme={isDefault:!1,name:"",items:[]},r.newThemeItem={search:"",page:1,totalPages:0,isPageInfoRetrieved:!1},r.getThemes(),r.showToast("Theme sucessfully saved to favorites.")}else r.showToast("A theme with that name already exists in your favorites!")},r.newThemeItemSearchChange=function(){r.isSearchRun=!1,r.isResultsForNewThemeItem=!1,""!=r.newThemeItem.search&&(r.isSearchRun=!1,r.isLoadingDone=!1,n.nyplSearch(r.newThemeItem.search,1).then(function(e){var t=e.data.nyplAPI.response.numResults;t>0&&(r.newThemeItemResultCount=t,r.isResultsForNewThemeItem=!0),r.isLoadingDone=!0,r.isSearchRun=!0}))},r.loadSelectedTheme=function(){return deferred=o.defer(),void 0!=r.theme?deferred.resolve():i.getUserInfo().then(function(e){null==e.selectedTheme?console.log("No selected theme for this user!"):(r.theme=e.selectedTheme,r.searchText=r.theme.name),deferred.resolve()}),deferred.promise},r.editTheme=function(){void 0!=r.theme&&(r.newTheme=r.theme,r.isEditing=!0)},r.deleteTheme=function(){void 0!=r.theme&&(i.deleteSelectedTheme(r.theme),r.showToast("Theme deleted."))},r.selectedItemChange=function(e){r.theme=e},r.searchTextChange=function(e){},r.hide=function(){e.hide()},r.cancel=function(){e.hide()},r.save=function(){if(void 0!=r.theme){var t=angular.toJson(r.theme),o=JSON.parse(t);i.saveSelectedTheme(o),s.url(s.path());var n="/search";s.path(n),e.hide()}else r.showToast("No theme selected. Save failed!")},r.loadSelectedTheme(),r.getThemes()}]),nyplViewer.factory("FirebaseStorageModel",["firebase","Auth","$q",function(e,t,o){return{deleteSelectedTheme:function(o){console.log(o);var n=t.authObj.$getAuth();e.database().ref("users").child(n.uid).child("themes").child(o.id).remove()},saveSelectedTheme:function(o){var n=t.authObj.$getAuth();e.database().ref("users").child(n.uid).child("selectedTheme").set(o)},getUserInfo:function(){var o=t.authObj.$getAuth();return e.database().ref("users").child(o.uid).once("value").then(function(e){var t=e.val();return t})},getThemes:function(){var o=t.authObj.$getAuth();return e.database().ref("users").child(o.uid).child("themes").once("value").then(function(e){var t=e.val();return t})},getSubmittedThemes:function(){t.authObj.$getAuth();return e.database().ref("submittedThemes").once("value").then(function(e){var t=e.val();return t})},getDefaultThemes:function(){t.authObj.$getAuth();return e.database().ref("defaultThemes").once("value").then(function(e){var t=e.val();return t})},createTheme:function(o){var n=t.authObj.$getAuth(),a=e.database().ref("users").child(n.uid).child("themes").push();a.set(o);var i=e.database().ref("submittedThemes").push();i.set(o)},createDefaultTheme:function(o){var n=(t.authObj.$getAuth(),e.database().ref("defaultThemes").push());n.set(o)},deleteSubmittedTheme:function(o){t.authObj.$getAuth();e.database().ref("submittedThemes").child(o.id).remove()},editDefaultTheme:function(o){var n=(t.authObj.$getAuth(),o.id);delete o.id,e.database().ref("defaultThemes").child(n).set(o)},editTheme:function(o){var n=t.authObj.$getAuth(),a=o.id;delete o.id,e.database().ref("users").child(n.uid).child("themes").child(a).set(o)}}}]),nyplViewer.service("LocalStorageModel",["$localStorage","$q",function(e,t){var o=this;return o.$storage=e,o.create=function(){o.$storage.user={name:"defaultUser",email:"",settings:{interests:[]}}},{getSettings:function(){var e=t.defer();return void 0==o.$storage.user&&o.create(),e.resolve(o.$storage.user.settings),e.promise},saveSettings:function(e){console.log(e),o.$storage.user.settings=e}}}]),nyplViewer.factory("Auth",["firebase","$firebaseAuth","$firebaseObject","lodash",function(e,t,o,n){var a=this,i={apiKey:"AIzaSyB-Ye7lD1r4D8Dj2QI0Xqy3dOQUl7srC-w",authDomain:"monocular-d0cad.firebaseapp.com",databaseURL:"https://monocular-d0cad.firebaseio.com",storageBucket:"monocular-d0cad.appspot.com",messagingSenderId:"487697293908"};return e.initializeApp(i),a.authObj=t(),a.getDefaultThemes=function(){a.authObj.$getAuth();return e.database().ref("defaultThemes").once("value").then(function(e){var t=e.val();return t})},a.writeUserData=function(t,o,i){a.getDefaultThemes().then(function(a){var s=n.sample(a);e.database().ref("users/"+t).set({name:o,email:i,themes:[],selectedTheme:s})})},a.checkForFirstTime=function(t){e.database().ref("users").child(t).once("value",function(e){var t=null!==e.val();return!!t})},{authenticate:function(t){return"Google"==t?a.authObj.$signInWithPopup("google").then(function(e){if(!a.checkForFirstTime(o)){var t=e.user,o=t.uid,n=t.displayName,i=t.email;a.writeUserData(o,n,i)}return e}).catch(function(e){return e}):"Anonymous"==t?e.auth().signInAnonymously().then(function(e){var t=e.uid,o=e.displayName,n=e.email;if(!a.checkForFirstTime(t)){e.user;a.writeUserData(t,o,n)}return e}).catch(function(e){console.log(e);e.code,e.message;return e}):void 0},saveSettings:function(t){var o=a.authObj.$getAuth();e.database().ref("users").child(o.uid).set({settings:t})},getSettings:function(){var t=a.authObj.$getAuth();return e.database().ref("users").child(t.uid).child("settings").once("value").then(function(e){var t=e.val();return t})},authObj:a.authObj}}]),nyplViewer.service("DatabaseConnection",["FirebaseStorageModel","LocalStorageModel","Auth",function(e,t,o){return{deleteSelectedTheme:function(n){o.authObj.$getAuth()?e.deleteSelectedTheme(n):t.deleteSelectedTheme(n)},saveSelectedTheme:function(n){o.authObj.$getAuth()?e.saveSelectedTheme(n):t.saveSelectedTheme(n)},getUserInfo:function(){return o.authObj.$getAuth()?e.getUserInfo():t.getUserInfo()},getThemes:function(){return o.authObj.$getAuth()?e.getThemes():[]},createTheme:function(t){if(o.authObj.$getAuth())return e.createTheme(t)},editTheme:function(t){if(o.authObj.$getAuth())return e.editTheme(t)}}}]),nyplViewer.factory("NyplApiCalls",["$http","$q","$base64","lodash",function(e,t,o,n){function a(e){return{method:"GET",url:e,headers:{Authorization:"Basic "+s}}}var i=this;i.page=1,i.resultCount=0;var s=o.encode("NomanTrips:water1bury"),r={Authorization:'Token token="'+s+'"'};return i.incrementResultPage=function(){i.page=i.page+1},{nyplSearch:function(o,n,i){var s="";switch(i){case"All":s="";break;case"Topic":s="&field=topic";break;case"Title":s="&field=title";break;case"Geographic":s="&field=geographic"}var l="";l="&page="+n;var c="http://localhost:80/api/v1/items/search?q="+o+l+"&per_page=20"+s,u=(t.defer(),e(a(c),{headers:r}));return u},getImage:function(o){var n=t.defer();return e(a(o.apiItemDetailURL),{headers:r}).then(function(e){var t=e.data,a={};void 0!=t.nyplAPI.response.sibling_captures.capture.imageLinks&&void 0!=t.nyplAPI.response.sibling_captures.capture.imageLinks.imageLink&&0!=Object.keys(t.nyplAPI.response.sibling_captures.capture.imageLinks.imageLink).length?(a.thumbnailUrl=t.nyplAPI.response.sibling_captures.capture.imageLinks.imageLink[4].$,a.fullImageUrl=t.nyplAPI.response.sibling_captures.capture.imageLinks.imageLink[0].$,a.title=o.title):void 0!=t.nyplAPI.response.sibling_captures.capture[0]&&void 0!=t.nyplAPI.response.sibling_captures.capture[0].imageLinks.imageLink&&0!=Object.keys(t.nyplAPI.response.sibling_captures.capture[0].imageLinks.imageLink).length?(a.thumbnailUrl=t.nyplAPI.response.sibling_captures.capture[0].imageLinks.imageLink[4].$,a.fullImageUrl=t.nyplAPI.response.sibling_captures.capture[0].imageLinks.imageLink[0].$,a.title=o.title):(console.log("setting undefined"),a=void 0),n.resolve(a)},function(e){console.log("error in servive"),n.reject(e)}),n.promise},getDetail:function(o){var i=t.defer(),s="http://localhost:80/api/"+n.trim(o,"http://api.repo.nypl.org");return e(a(s),{headers:r}).then(function(e){var t=e.data;i.resolve(t)},function(e){console.log("error in service"),i.reject(e)}),i.promise}}}]);